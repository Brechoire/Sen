{% extends 'admin_panel/base_admin.html' %}
{% load static %}

{% block admin_content %}
<div class="space-y-6">
    <!-- En-tête -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-dark">Marquer le livre comme disponible</h2>
            <p class="text-gray-600 mt-2">Convertir les précommandes en commandes normales et notifier les clients</p>
        </div>
        <a href="{% url 'admin_panel:books' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
            Retour à la liste
        </a>
    </div>

    <!-- Informations du livre -->
    <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-xl font-semibold text-dark mb-4">Informations du livre</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-600">Titre</p>
                <p class="font-semibold text-dark">{{ book.title }}</p>
            </div>
            {% if book.preorder_available_date %}
            <div>
                <p class="text-sm text-gray-600">Date de disponibilité prévue</p>
                <p class="font-semibold text-dark">{{ book.preorder_available_date|date:"d/m/Y" }}</p>
            </div>
            {% endif %}
            <div>
                <p class="text-sm text-gray-600">Précommandes effectuées</p>
                <p class="font-semibold text-dark">{{ book.preorder_current_quantity }}</p>
            </div>
            {% if book.preorder_max_quantity %}
            <div>
                <p class="text-sm text-gray-600">Quantité maximale</p>
                <p class="font-semibold text-dark">{{ book.preorder_max_quantity }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistiques des précommandes -->
    <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-xl font-semibold text-dark mb-4">Précommandes à traiter</h3>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-blue-800">
                <strong>{{ preorder_count }} précommande(s)</strong> seront convertie(s) en commande(s) normale(s) 
                et les clients seront notifiés par email.
            </p>
        </div>

        {% if preorder_orders %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Numéro</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in preorder_orders %}
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ order.order_number }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ order.user.get_full_name|default:order.user.username }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ order.created_at|date:"d/m/Y H:i" }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ order.total_amount|floatformat:2 }} €</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if preorder_count > 10 %}
            <p class="text-sm text-gray-600 mt-2">... et {{ preorder_count|add:"-10" }} autre(s) précommande(s)</p>
            {% endif %}
        </div>
        {% else %}
        <p class="text-gray-600">Aucune précommande trouvée pour ce livre.</p>
        {% endif %}
    </div>

    <!-- Formulaire de confirmation -->
    <div class="bg-white p-6 rounded-lg shadow-sm border">
        <h3 class="text-xl font-semibold text-dark mb-4">Actions à effectuer</h3>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                <p class="text-yellow-800">
                    <strong>Attention :</strong> Cette action va :
                </p>
                <ul class="list-disc list-inside text-yellow-800 mt-2 space-y-1">
                    <li>Marquer le livre comme disponible (retirer le statut de précommande)</li>
                    <li>Convertir toutes les précommandes en commandes normales</li>
                    <li>Envoyer un email de notification à chaque client concerné</li>
                </ul>
            </div>

            <div class="flex items-start">
                <input type="checkbox" id="convert_orders" name="convert_orders" checked class="mt-1 mr-2">
                <label for="convert_orders" class="text-gray-700">
                    Convertir automatiquement les précommandes en commandes normales et envoyer les emails de notification
                </label>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="submit" class="bg-primary hover:bg-secondary text-white px-6 py-2 rounded-lg transition-colors">
                    Confirmer et envoyer les notifications
                </button>
                <a href="{% url 'admin_panel:books' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition-colors">
                    Annuler
                </a>
            </div>
        </form>
    </div>

    <!-- Information sur l'envoi groupé -->
    <div class="bg-gray-50 p-4 rounded-lg border">
        <p class="text-sm text-gray-600">
            <strong>Note :</strong> Les emails seront envoyés par lots pour respecter les limites Gmail. 
            Le processus peut prendre quelques minutes selon le nombre de précommandes.
        </p>
    </div>
</div>
{% endblock %}



